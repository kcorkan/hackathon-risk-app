<!DOCTYPE html>
<html>
<head>
    <title>portfolio-item-risk-app</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",defaults:{margin:10},items:[{xtype:"container",itemId:"header_box"},{xtype:"container",itemId:"display_box",layout:{type:"hbox"}}],aggregateNumberField:"ValueScore",modelType:"PortfolioItem/Feature",featureFetchFields:["FormattedID","Name","State","_ProjectHierarchy","PercentDoneByStoryCount","PlannedStartDate","PlannedEndDate","ActualStartDate","ActualEndDate"],modelObject:void 0,riskMapping:[{name:"R3",color:"#F66349",cls:"r3"},{name:"R2",color:"#FAD200",cls:"r2"},{name:"R1",color:"#8DC63F",cls:"r1"},{name:"Not Started",color:"#888",cls:"notstarted"},{name:"Done",color:"#3F86C9",cls:"done"}],launch:function(){var promises=[this._fetchModel(),this._fetchChildProjects()];Deft.Promise.all(promises).then({scope:this,success:function(results){console.log("model",results),this.modelObject=results[0],this.childProjectHash=results[1],this._addSelectorComponents()},failure:function(operation){Rally.ui.notify.Notifier.showError("Error retrieving child projects: "+operation.error.errors.join(","))}})},_fetchModel:function(){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:this.modelType,success:function(model){deferred.resolve(model)}}),deferred},_fetchReleases:function(cb){var deferred=Ext.create("Deft.Deferred"),release_name=cb.getRecord().get("Name"),store=Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID","Name"],filters:[{property:"Name",value:release_name}]});return store.load({scope:this,callback:function(records,operation,success){success?(console.log("release records",records),this._fetchData(records)):Rally.ui.notify.Notifier.showError({message:"Error getting Releases: "+operation.error.errors.join(",")})}}),deferred},_fetchChildProjects:function(){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","ObjectID"],filters:[{property:"Parent.ObjectID",value:this.getContext().getProject().ObjectID}],limit:1/0});return store.load({scope:this,callback:function(records,operation,success){if(success){var projectHash={};_.each(records,function(r){projectHash[r.get("ObjectID")]=r.get("Name")}),deferred.resolve(projectHash)}else deferred.reject(operation)}}),deferred},_addSelectorComponents:function(){this.down("#header_box").add({xtype:"rallyreleasecombobox",fieldLabel:"Release",labelAlign:"right",context:{project:this.getContext().getProject()._ref,projectScopeDown:this.getContext().getProjectScopeDown(),projectScopeUp:!1},allowNoEntry:!1,width:300,listeners:{scope:this,change:this._fetchReleases}})},_fetchData:function(releases){var model_name=this.modelType,field_names=this.featureFetchFields,release_oids=_.map(releases,function(rel){return rel.get("ObjectID")});this.setLoading(!0);var store=Ext.create("Rally.data.lookback.SnapshotStore",{fetch:field_names,find:{_TypeHierarchy:model_name,_ProjectHierarchy:this.getContext().getProject().ObjectID,Release:{$in:release_oids},__At:"current"}});store.load({scope:this,callback:function(records,operation,success){success?(console.log("records",records),this._buildGridAndChart(records),this.setLoading(!1)):(this.setLoading(!1),Rally.ui.notify.Notifier.showError({message:"Error fetching data: "+operation.error.errors.join(",")}))}})},_buildGridAndChart:function(records){this.down("#display_box").removeAll();var aggregate_data=this._aggregateData(records),grid_ct=this.down("#display_box").add({xtype:"container",flex:1}),chart_ct=this.down("#display_box").add({xtype:"container",flex:2});this._buildChart(chart_ct,aggregate_data),this._buildGridView(grid_ct,aggregate_data)},_buildChart:function(chart_ct,aggregate_data){var colors=[];_.each(this.riskMapping,function(rm){colors.push(rm.color)});var chart=chart_ct.add({xtype:"rallychart",itemId:"rally-chart",loadMask:!1,chartConfig:this._getChartConfig(),chartData:this._getChartData(aggregate_data),chartColors:colors})},_getChartData:function(aggregate_data){for(var categories=_.keys(aggregate_data),riskCategories=this.riskMapping,series=[],j=0;riskCategories.length>j;j++){for(var series_obj={name:riskCategories[j].name,data:[],color:riskCategories[j].color},i=0;categories.length>i;i++)series_obj.data.push(aggregate_data[categories[i]][riskCategories[j].name].length);series.push(series_obj)}return console.log("categories",categories,"series",series),{categories:categories,series:series}},_getChartConfig:function(){var me=this;return{chart:{type:"column"},title:{text:"Features by Risk Category",align:"left"},legend:{align:"right",verticalAlign:"top",floating:!0,backgroundColor:"white",borderColor:"#CCC",borderWidth:1,shadow:!1},tooltip:{formatter:function(){return"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.y+"<br/>"+"Total: "+this.point.stackTotal}},yAxis:{title:{text:"# Features"}},xAxis:{title:{text:"Projects"}},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:"white",formatter:function(){return 0>=this.y?"":this.y}},point:{events:{click:function(evt){me._onPointSelected(evt,me)}}}}}}},_onPointSelected:function(evt,thisApp){var point=evt.currentTarget;console.log("click",evt,point,point.category,point.series.name,thisApp,thisApp._getRiskCategoryItemId(point.category,point.series.name)),thisApp.down("#"+thisApp._getProjectItemId(point.category)).expand(),thisApp.down("#"+thisApp._getRiskCategoryItemId(point.category,point.series.name)).expand()},_buildGridView:function(ct_grid,aggregate_data){console.log("_buildGridView",aggregate_data);var items=[];_.each(aggregate_data,function(obj,proj){var risk_items=[];_.each(obj,function(records,riskCategory){if(records.length>0){var risk_store=Ext.create("Rally.data.custom.Store",{pageSize:records.length,data:records});risk_items.push({title:'<div class="'+this._getRiskCategoryClass(riskCategory)+'">'+riskCategory+" ("+records.length+")</div>",itemId:this._getRiskCategoryItemId(proj,riskCategory),header:{cls:this._getRiskCategoryClass(riskCategory)},items:[{xtype:"rallygrid",store:risk_store,columnCfgs:[{dataIndex:"FormattedID",text:"Formatted ID"},{dataIndex:"Name",text:"Name",flex:1}],showPagingToolbar:!1,showRowActionsColumn:!1}]})}},this);var risk_pnl=Ext.create("Ext.panel.Panel",{title:'<div class="head">'+proj+"</div>",cls:"x4-container-default x4-container fieldBucket",header:{cls:"x4-component x4-component-default head"},flex:1,itemId:this._getProjectItemId(proj),defaults:{bodyStyle:"padding:15px"},layout:{type:"accordion",titleCollapse:!1,animate:!0},items:risk_items});items.push(risk_pnl)},this);var pnl=Ext.create("Ext.panel.Panel",{flex:1,defaults:{bodyStyle:"padding:15px;border:0px"},layout:{type:"accordion",titleCollapse:!1,animate:!0,activeOnTop:!0},items:items});ct_grid.add(pnl)},_getRiskCategoryClass:function(riskCategory){var cls="";return _.each(this.riskMapping,function(rm){rm.name==riskCategory&&(cls=rm.cls)}),cls},_getRiskCategoryItemId:function(project,risk){return(project+"-"+risk).replace(/\s/g,"")},_getProjectItemId:function(project){return project.replace(/\s/g,"")},_aggregateData:function(records){var aggregate_data={},risk_categories=[];return console.log("child project hash",this.childProjectHash),_.each(this.riskMapping,function(obj){risk_categories.push(obj.name)}),_.each(records,function(rec){var proj=this._getProjectCategory(rec),risk_category=this._getRiskCategory(rec,this.aggregateNumberField);aggregate_data[proj]||(aggregate_data[proj]={},_.each(risk_categories,function(rc){aggregate_data[proj][rc]=[]})),aggregate_data[proj][risk_category].push(rec)},this),aggregate_data},_getProjectCategory:function(rec){var project_hierarchy=rec.get("_ProjectHierarchy"),current_project_idx=_.indexOf(project_hierarchy,this.getContext().getProject().ObjectID);if(console.log("proj hierarchy",project_hierarchy,current_project_idx),0>current_project_idx)return"Unknown";if(this.getContext().getProject().ObjectID==project_hierarchy.slice(-1)[0])return this.getContext().getProject().Name;var project_category_oid=project_hierarchy[current_project_idx+1];return this.childProjectHash[project_category_oid]},_getRiskCategory:function(rec,riskField){var startDate=new Date,percentComplete=100*rec.get("PercentDoneByStoryCount");rec.get("ActualStartDate")?startDate=Rally.util.DateTime.fromIsoString(rec.get("ActualStartDate")):rec.get("PlannedStartDate")&&(startDate=Rally.util.DateTime.fromIsoString(rec.get("PlannedStartDate")));var endDate=new Date;100==percentComplete&&rec.get("ActualEndDate")?endDate=Rally.util.DateTime.fromIsoString(rec.get("ActualEndDate")):rec.get("PlannedEndDate")&&(endDate=Rally.util.DateTime.fromIsoString(rec.get("PlannedEndDate")));var deltaDays=Rally.util.DateTime.getDifference(endDate,startDate,"day"),acceptanceStartDelay=.2*deltaDays,warningDelay=.2*deltaDays,inProgress=percentComplete>0;if(startDate>new Date)return"Not Started";if(new Date>=endDate)return percentComplete>=100?"Done":"R3";var startDay=0,asOfDay=Rally.util.DateTime.getDifference(new Date,startDate,"day"),endDay=deltaDays,redXIntercept=startDay+acceptanceStartDelay+warningDelay,redSlope=100/(endDay-redXIntercept),redYIntercept=-1*redXIntercept*redSlope,redThreshold=redSlope*asOfDay+redYIntercept;if(console.log("getRiskCategory red",rec.get("FormattedID"),percentComplete,redThreshold,startDate,endDate,percentComplete,redXIntercept,redSlope,redYIntercept,redThreshold),redThreshold>percentComplete)return"R3";var yellowXIntercept=startDay+acceptanceStartDelay,yellowSlope=100/(endDay-yellowXIntercept),yellowYIntercept=-1*yellowXIntercept*yellowSlope,yellowThreshold=yellowSlope*asOfDay+yellowYIntercept;return console.log("getRiskCategory yellow",rec.get("FormattedID"),percentComplete,yellowThreshold,startDate,endDate,yellowXIntercept,yellowSlope,yellowYIntercept),yellowThreshold>percentComplete?"R2":"R1"}});

            Rally.launchApp('CustomApp', {
                name:"portfolio-item-risk-app",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .r1{background-color:#8DC63F!important}.r2{background-color:#FAD200!important}.r3{background-color:#F66349!important}.done{background-color:#888!important}.notstarted{background-color:#3f86c9!important}.project{background-color:#f6f6f6;font-family:'proximanovasemibold'}.x-accordion-item .x-accordion-hd{background-color:#f6f6f6;border-top-color:#f3f7fb;padding:4px 5px 5px 5px}.x-panel-body-default{border-width:0px!important;border-style:none}
    </style>
</head>
<body>
</body>
</html>
