<!DOCTYPE html>
<html>
<head>
    <title>portfolio-item-risk-app</title>

    <script type="text/javascript" src="https://demo-west.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",defaults:{margin:10},items:[{xtype:"container",itemId:"header_box"},{xtype:"container",itemId:"display_box",layout:{type:"hbox"}}],aggregateNumberField:"ValueScore",launch:function(){this._fetchProjects().then({scope:this,success:function(projects){this.projectTree=this._getProjectTree(projects,this.getContext().getProject().ObjectID),this._addSelectorComponents()},failure:function(operation){Rally.ui.notify.Notifier.showError({message:"Error getting Project Tree: "+operation.error.errors.join(",")})}})},_fetchProjects:function(){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID"],limit:1/0,context:{project:this.getContext().getProject()._ref,projectScopeDown:!0,projectScopeUp:!1}});return store.load({scope:this,callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject(operation)}}),deferred},_addSelectorComponents:function(){this.down("#header_box").add({xtype:"rallyreleasecombobox",fieldLabel:"Release",labelAlign:"right",context:{project:this.getContext().getProject()._ref,projectScopeDown:this.getContext().getProjectScopeDown(),projectScopeUp:!1},allowNoEntry:!1,width:300,listeners:{scope:this,change:this._fetchData}})},_fetchData:function(cb){var model_name="PortfolioItem/Feature",field_names=["FormattedID","Name","Project","State"].concat([this.aggregateNumberField]);this.setLoading(!0);var filters=[{property:"Release.Name",value:cb.getRecord().get("Name")}],store=Ext.create("Rally.data.wsapi.Store",{model:model_name,fetch:field_names,filters:filters,limit:1/0});store.load({scope:this,callback:function(records,operation,success){success?(this._buildGridAndChart(records),this.setLoading(!1)):(this.setLoading(!1),Rally.ui.notify.Notifier.showError({message:"Error fetching data: "+operation.error.errors.join(",")}))}})},_buildGridAndChart:function(records){this.down("#display_box").removeAll();var aggregate_data=this._aggregateData(records,this.projectTree);this._buildGridView(aggregate_data),this._buildChart(aggregate_data)},_buildChart:function(aggregate_data){var ct=this.down("#display_box").add({xtype:"container",flex:1}),chart=ct.add({xtype:"rallychart",itemId:"rally-chart",chartConfig:this._getChartConfig(),chartData:this._getChartData(aggregate_data)})},_getChartData:function(aggregate_data){for(var categories=_.keys(aggregate_data),riskCategories=["R1","R2","R3"],series=[],j=0;riskCategories.length>j;j++){for(var series_obj={name:riskCategories[j],data:[]},i=0;categories.length>i;i++)series_obj.data.push(aggregate_data[categories[i]][riskCategories[j]].length);series.push(series_obj)}return console.log("categories",categories,"sereis",series),{categories:categories,series:series}},_getChartConfig:function(){return{chart:{type:"column"},title:{text:"Risk"},legend:{align:"right",x:-30,verticalAlign:"top",y:25,floating:!0,backgroundColor:"white",borderColor:"#CCC",borderWidth:1,shadow:!1},tooltip:{formatter:function(){return"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.y+"<br/>"+"Total: "+this.point.stackTotal}},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:"white",style:{textShadow:"0 0 3px black"}}}}}},_buildGridView:function(aggregate_data){console.log("_buildGridView",aggregate_data);var items=[];_.each(aggregate_data,function(obj,proj){var risk_items=[];_.each(obj,function(records,riskCategory){var html="No Data";if(records.length>0){var rec_array=_.map(records,function(r){return r.get("FormattedID")+": "+r.get("Name")});console.log("rec_array",rec_array),html=rec_array.join("<br/>")}risk_items.push({title:riskCategory+" ("+records.length+")",html:html})},this);var risk_pnl=Ext.create("Ext.panel.Panel",{title:proj,defaults:{bodyStyle:"padding:15px"},layout:{type:"accordion",titleCollapse:!1,animate:!0},items:risk_items});items.push(risk_pnl)},this);var pnl=Ext.create("Ext.panel.Panel",{flex:1,defaults:{bodyStyle:"padding:15px"},layout:{type:"accordion",titleCollapse:!1,animate:!0,activeOnTop:!0},items:items});this.down("#display_box").add(pnl)},_aggregateData:function(records,projectTree){var aggregate_data={};return _.each(records,function(rec){var proj=this._getProjectCategory(rec,this.projectTree),risk_category=this._getRiskCategory(rec,this.aggregateNumberField);console.log("project",rec.get("Project").Name,proj,this.projectTree),aggregate_data[proj]||(aggregate_data[proj]={R1:[],R2:[],R3:[]}),aggregate_data[proj][risk_category].push(rec)},this),aggregate_data},_getProjectCategory:function(rec,projectTree){var project_name=rec.get("Project").Name,project_category="unknown";return project_name==projectTree.get("Name")?project_name:(_.each(projectTree.get("Children"),function(child){this._isInProjectHierarchy(child,project_name)&&(project_category=child.get("Name"))},this),console.log("cateory",project_category),project_category)},_isInProjectHierarchy:function(project,project_name){var isInProjectHierarchy=!1;return console.log("_isprojecthierarchy",project.get("Name"),project_name),project.get("Name")==project_name?!0:(_.each(project.get("Children"),function(child){this._isInProjectHierarchy(child,project_name)&&(isInProjectHierarchy=!0)},this),isInProjectHierarchy)},_getRiskCategory:function(rec,riskField){var risk=rec.get(riskField)||0;return 10>=risk?"R1":20>=risk?"R2":"R3"},_getProjectTree:function(records,currentProjectObjectID){console.log("_getProjectTree",records);var projectHash={};_.each(records,function(rec){projectHash[rec.get("ObjectID")]=rec,rec.set("Children",[])});var current_root=null,root_array=[];return Ext.Object.each(projectHash,function(oid,item){console.log("project tree",oid,item.get("Name"),item,item.get("Parent")),item.get("Children")||item.set("Children",[]);var direct_parent=item.get("Parent");if(direct_parent||Ext.Array.contains(root_array,item)){var parent_oid=direct_parent.ObjectID||direct_parent.get("ObjectID");if(projectHash[parent_oid]){var parent=projectHash[parent_oid];parent.get("Children")||parent.set("Children",[]);var kids=parent.get("Children");kids.push(item),parent.set("Children",kids)}else Ext.Array.contains(root_array,item)||root_array.push(item)}else root_array.push(item);item.get("ObjectID")==currentProjectObjectID&&(current_root=item)},this),console.log("getProjectTree",current_root),current_root}});

            Rally.launchApp('CustomApp', {
                name:"portfolio-item-risk-app",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
